
@{
    Layout = "~/Views/Shared/_WelcomeLayout.cshtml";
    ViewData["Title"] = "Giriş";
}

<div class="card-body p-4">

    <div class="text-center w-75 m-auto">
        <h4 class="text-dark-50 text-center pb-0 fw-bold">Xoş gəlmişsiniz!</h4>
        <p class="text-muted mb-4">Sağlamlığınızı buludlara qaldırın</p>
    </div>
    <div class="alert alert-danger" id="alert" hidden role="alert"></div>
    <form action="#" autocomplete="off">

        <div class="mb-3">
            <label for="emailaddress" class="form-label">Mobil nömrə</label>

            <div class="form-group">
                <input autocomplete="false" 
                       type="text" 
                       class="masked-phone form-control"
                       data-phonemask="+994 (__) ___-__-__" 
                       id="mobileNumber"
                       name="mobileNumber"
                       placeholder="+994" />
            </div>
        </div>

        <div class="mb-3">
            <a href="@Url.Action("Index","Recovery")" class="text-muted float-end"><small>Şifrənizi unutmusuz?</small></a>
            <label for="password" class="form-label">Şifrə</label>
            <div class="input-group input-group-merge">
                <input type="password" id="passBox" class="form-control" placeholder="Şifrəni daxil edin">
                <div class="input-group-text" data-password="false">
                    <span class="password-eye"></span>
                </div>
            </div>
        </div>

        @*<div class="mb-3 mb-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="checkbox-signin" checked>
                    <label class="form-check-label" for="checkbox-signin">Remember me</label>
                </div>
            </div>*@

        <div class="mb-3 mb-0 text-center">
            <button class="btn btn-primary" onclick="signIn(this)" id="signInButton"> Daxil ol </button>
        </div>

    </form>
</div> <!-- end card-body -->


@section Scripts{
    <script src="~/js/phone-mask-min.js"></script>

    <script>
        function setCursorToLastPlaceholder(input) {
            const placeholder = input.value;
            const cursorPos = placeholder.indexOf('_');

            input.focus();

            input.setSelectionRange(cursorPos, cursorPos);
        }

        document.getElementById('mobileNumber').addEventListener('click', function () {
            setCursorToLastPlaceholder(this);
        });

        $(document).ready(function () {
            // Enter key event listener for sign in
            $('#phone, #passBox').keypress(function (event) {
                if (event.which === 13) {
                    event.preventDefault();

                    signIn($('#signInButton'));
                }
            });

            function signIn(btn) {
                let $btn = $(btn);
                let mobileNumber = $("#mobileNumber").val();
                let password = $("#passBox").val();
                let $alert = $("#alert");
                let formattedNumber = mobileNumber
                    .replace(/\+994\s*\(/, '')         
                    .replace(/\)\s*/, '')              
                    .replace(/[\s-]/g, ''); 

                // Disable button and show loading state
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="signInSpinner"></span> Yüklənir...');

                // Validate inputs
                if (formattedNumber.length === 0) {
                    showError('Xahiş olunur nömrənizin düzgünlüyünə diqqət edəsiniz!');
                    return;
                }

                if (!password) {
                    showError('Xahiş olunur daxil etdiyiniz məlumatların düzgünlüyünə diqqət edəsiniz!');
                    return;
                }

                // Ajax POST request
                $.ajax({
                    type: 'POST',
                    url : '@Url.Action("SignIn","Login")',
                    data: { mobileNumber: formattedNumber, pass: password },
                    dataType: 'json',
                    success: function (data, status, xhr) {
                        handleLoginSuccess(data, xhr.status);
                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                        handleLoginError(jqXhr.status);
                    }
                });

                function showError(message) {
                    $alert.text(message).removeAttr("hidden");
                    resetButton();
                }

                function resetButton() {
                    $btn.prop('disabled', false).text('Daxil ol');
                }

                function handleLoginSuccess(data, statusCode) {
                    resetButton();
                    if (statusCode === 200) {
                        if (typeof (Storage) !== "undefined") {
                            localStorage.json = JSON.stringify(data);
                            window.location.replace("/Home/Index");
                        } else {
                            showError('Brauzerinizi yeniləyin, dəstəklənmir');
                        }
                    } else {
                        showError('İstifadəçi mövcud deyil');
                    }
                }

                function handleLoginError(statusCode) {
                    resetButton();
                    if (statusCode === 401) {
                        showError('İstifadəçi mövcud deyil');
                    } else {
                        showError('Xəta, internetə bağlı olduğunuzdan əmin olun');
                    }
                }
            }
            window.signIn = signIn; // Make the logout function globally accessible

            // The getCookie function is commented out as it's not used in the signIn function
            // If you need it for other parts of your application, you can uncomment it.
            // function getCookie(cname) {
            //     ...
            // }
        });</script>
}