@{
    Layout = "~/Areas/Business/Views/Shared/_BusinessLayout.cshtml";
}


@*

    @*
        For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

@model Medicloud.ViewModels.CreateOrganizationVM


@{
    var serviceTypes = Model.ServiceTypes.ServiceTypes;
    var serviceTypeCategories = Model.ServiceTypes.ServiceTypeCategories;
    var groupedCategories = serviceTypes
    .GroupBy(type => type.typeCategoryId)
    .ToList();
}


<div class="">
    <div class="row  text-center justify-content-center ">
        <div class="">
            <div class="card-header   align-items-center">
                <div class="text-center flex-grow-1">
                    <h4>Xidmətləri əlavə etməyə başlayın</h4>
                    <p>İndi ən azı bir xidmət əlavə edin.Sonra daha çox əlavə edə, təfərrüatları redaktə edə və xidmətləri kateqoriyalara qruplaşdıra bilərsiniz</p>
                </div>
            </div>
            <form id="step9Form" method="post" asp-action="success" asp-controller="registration" asp-area="Business">
                <div class="alert alert-danger" role="alert" id="errorMessage" style="display:none;">
                    Zəhmət olmasa ən azı bir xidmət əlavə edin.
                </div>
                <div class="card-body ">
                    @{
                        int count = 0;
                    }
                    @foreach (var service in Model.Services)
                    {
                        count++;
                        <div class="row  align-items-center mb-3">
                            <div class="col-6 row align-items-center">
                                <div class="col-4 d-flex align-items-center ">
                                    @count.
                                    <btn class="btn btn-sm remove-button" data-item-id="@service.id">
                                        <img src="~/fi_trash-2.svg" />
                                    </btn>
                                </div>

                                <div class="col-8 text-start">
                                    <label class="form-check-label text-start" style="cursor:pointer;">@service.name</label>

                                </div>

                            </div>
                            <div class="col-6 row align-items-center item-row">
                                <div class="col-8">
                                    <span class="text-muted">@service.price ₼</span>

                                </div>
                                <div class="col-4">
                                    <btn class="btn btn-sm detail-button" data-item-id="@service.id">
                                        <svg width="20px" height="20px" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#908e8e">
                                            <path d="M9 5L16 12L9 19" stroke="#737373" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </btn>
                                </div>

                            </div>
                        </div>
                    }

                    @{
                        var cultureInfo = new System.Globalization.CultureInfo("az-AZ");

                    }
                    <div class="text-start">
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addServiceModal" type="button">+ Xidmət əlavə et</button>
                    </div>
                </div>


                <div class="mb-3 d-flex justify-content-around align-items-center">
                    <a class="btn btn-sm" asp-action="Step8" asp-route-organizationId="@Model.id" asp-area="Business">
                        <svg width="32px" height="32px" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="#737373">
                            <path fill="#737373" d="M224 480h640a32 32 0 1 1 0 64H224a32 32 0 0 1 0-64z"></path>
                            <path fill="#737373" d="m237.248 512 265.408 265.344a32 32 0 0 1-45.312 45.312l-288-288a32 32 0 0 1 0-45.312l288-288a32 32 0 1 1 45.312 45.312L237.248 512z"></path>
                        </svg>
                    </a>
                    <a asp-action="Success" asp-route-organizationId="@Model.id" asp-area="Business" class="btn btn-primary" id="nextButton"> Növbəti</a>

                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceModalLabel">Xidmət əlavə et</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="serviceModalAddText">Xidmət haqqında əsas məlumatları daxil edin. Daha sonra redaktə edə bilərsiniz</p>
                <form id="addServiceForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="name" placeholder="Ad" required>
                        <label for="floatingInput">Xidmətin adı</label>
                        <div class="invalid-feedback">
                            Bu sahə doldurulmalıdır
                        </div>
                    </div>
                    <div class="row align-items-center">
                        <div class="form-floating col-11">
                            <select class="form-select" id="serviceType" required>
                                <option value="">Seçin</option>
                                @foreach (var categoryGroup in groupedCategories)
                                {
                                    var categoryName = serviceTypeCategories.FirstOrDefault(c => c.id == categoryGroup.Key).name;
                                    <optgroup label="@categoryName">
                                        @foreach (var category in categoryGroup)
                                        {
                                            <option value="@category.id">
                                                @category.name
                                            </option>
                                        }
                                    </optgroup>
                                }
                            </select>
                            <label for="floatingSelect">Xidmət növü</label>
                            <div class="invalid-feedback">
                                Bu sahə doldurulmalıdır
                            </div>
                        </div>
                        <div class="col-1 ps-1">
                            <img src="~/InfoOutlined.svg" alt="Info" style="cursor:pointer;" data-bs-toggle="tooltip" title="Xidmət növünün təyin edilməsi müştərilərə axtardıqlarını tapmağa kömək edir və həmçinin yeni müştərilərə sizi və xidmətlərinizi kəşf etməyə kömək edə bilər. Uyğun olan xidmət növünü tapa bilmirsinizsə, təyin edilməmişi seçə bilərsiniz, lakin  təyin olunmamış xidmətlərin axtarışda tapılma ehtimalı azdır." />
                        </div>
                    </div>
                    <div class="bg-light p-1 mt-1">
                        <div class="row mt-2 g-0 gx-1">
                            <div class="col-md-6">

                                <div class="form-floating">
                                    <select class="form-select" id="hour" aria-label="Floating label select example" required>
                                        @for (int i = 0; i < 24; i++)
                                        {


                                            if (i == 0)
                                            {
                                                <option value="@i" selected>@i s</option>

                                            }
                                            else
                                            {

                                                <option value="@i">@i s</option>

                                            }
                                        }
                                    </select>
                                    <label for="hour">Saat</label>
                                    <div class="invalid-feedback">
                                        Bu sahə doldurulmalıdır
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="minute" aria-label="Floating label select example" required>
                                        @for (int i = 0; i < 60; i += 5)
                                        {


                                            if (i == 15)
                                            {
                                                <option value="@i" selected>@i dəq</option>

                                            }
                                            else
                                            {

                                                <option value="@i">@i dəq</option>

                                            }
                                        }
                                    </select>
                                    <label for="floatingSelect">Dəqiqə</label>
                                    <div class="invalid-feedback">
                                        Bu sahə doldurulmalıdır
                                    </div>
                                </div>
                            </div>


                        </div>
                        <div class="row  mt-2 g-0 gx-1 mb-1 align-items-center">

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" name="TravelPrice" id="price" class="form-control" step="0.01" min="0.01" value="0.00" placeholder="9.99" required />
                                    <label for="priceInput">Qiymət(AZN)</label>
                                    <div class="invalid-feedback">
                                        Bu sahə doldurulmalıdır
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex justify-content-center">
                                <div class="form-check  mb-2">
                                    <input type="checkbox" style="cursor:pointer;" class="form-check-input" name="selectedCategories" value="" id="checkInputStart">
                                    <label class="form-check-label " style="cursor:pointer;" for="checkInputStart">Başlayaraq</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (Model.hasTravel)
                    {
                        <div class="row align-items-center my-3 form-switch px-1">
                            <div class="col-8 text-start">
                                <label class="form-check-label" style="cursor:pointer;" for="mobileService">Mobil xidmət</label>
                            </div>
                            <div class="col-4 text-end">
                                <input class="form-check-input toggle-checkbox" style="cursor:pointer;" type="checkbox" id="mobileService">
                            </div>
                        </div>

                    }

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ləğv et</button>
                <button type="button" class="btn btn-primary" data-action="add" id="saveButton">Yadda saxla</button>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>

        const $form = $('#addServiceForm');
        const $saveButton = $('#saveButton');
        $('#addServiceModal').on('hidden.bs.modal', function () {
            $form.removeClass('was-validated');
            $form[0].reset();
            $saveButton.data('action','add')
            $('#serviceModalAddText').show();
            $('#serviceModalLabel').text('Xidmət əlavə et');
        });


        $saveButton.on('click', function () {

            var form = $form[0];
            const totalMinute = (parseInt($('#hour').val()) * 60 + parseInt($('#minute').val()))

            if (totalMinute === 0) {
                $('#hour').addClass('is-invalid');
                $('#minute').addClass('is-invalid');

                return;
            } else {

                $('#hour').removeClass('is-invalid');
                $('#minute').removeClass('is-invalid');
            }
            if (!form.checkValidity())
                form.classList.add('was-validated');
            else {
                const action = $saveButton.data('action');
                const data = {
                    name: $('#name').val(),
                    typeId: $('#serviceType').val(),
                    isPriceStart: $('#checkInputStart').is(':checked'),
                    price: $('#price').val(),
                    time: totalMinute,
                    isMobile : $('#mobileService').is(':checked'),

                    organizationId:'@Model.id'
                };
                //console.log(data);
                showLoading();
                if (action === 'add') {
                    $.ajax({
                        url: `/Business/Services/AddService`,
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function (response) {
                            location.reload();
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                            hideLoading();

                        }
                    });
                }
                else if (action === 'update') {
                    data.id = $(this).data('item-id');
                    data.isMobile = $('#mobileService').is(':checked');
                    $.ajax({
                        url: `/Business/Services/UpdateService`,
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function (response) {
                            location.reload();
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                            hideLoading();
                        }
                    });
                }
                



            }
        });
        $('.remove-button').on('click', function () {
            const itemId = $(this).data('item-id');
            console.log(itemId)
            let orgId =@Model.id;
            console.log(orgId)
            showLoading();
            $.ajax({
                url: `/Business/Services/RemoveService?organizationId=${orgId}&serviceId=${itemId}`,
                type: 'POST',
                contentType: 'application/json',
                success: function (response) {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    hideLoading();

                }
            });

        });

        $('.detail-button').on('click', function () {
            const itemId = $(this).data('item-id');
            $saveButton.data('action', 'update')
            $saveButton.data('item-id', itemId)
            console.log(itemId)
            let orgId =@Model.id;
            console.log(orgId)
            $.ajax({
                url: `/Business/Services/GetService?serviceId=${itemId}`,
                type: 'GET',
                success: function (response) {
                    console.log(response)
                    const hours = Math.floor(response.time / 60);

                    const minutes = response.time % 60;


                    $('#name').val(response.name);
                    $('#serviceType').val(response.typeId);
                    $('#hour').val(hours);
                    $('#minute').val(minutes);
                    $('#price').val(response.price.toFixed(2));


                    if (response.isPriceStart) {
                        $('#checkInputStart').prop('checked', true);
                    } else {
                        $('#checkInputStart').prop('checked', false);
                    }


                    if (response.isMobile) {
                        $('#mobileService').prop('checked', true);
                    } else {
                        $('#mobileService').prop('checked', false);
                    }

                    $('#serviceModalAddText').hide();
                    $('#serviceModalLabel').text('Detallar');
                    $('#addServiceModal').modal('show');

                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });

        });


        $('#nextButton').on('click', function (e) {
            e.preventDefault();
            if ('@Model.Services.Count' == 0) {
                $('#errorMessage').show();
            }
            else {
                window.location.href=$(this).attr('href')
            }
        })

    </script>
}