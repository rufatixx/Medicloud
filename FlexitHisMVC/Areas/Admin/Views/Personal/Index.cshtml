@model Medicloud.Areas.Admin.Model.PersonalPageDTO

@{
    ViewData["Title"] = "- Personal";

    var userId = User.FindFirst("ID")?.Value;
    var currentUser = Model.personalList.FirstOrDefault(p => p.ID.ToString() == userId);




}

<!-- ================================================== -->
<!-- HEADER SECTION -->
<!-- ================================================== -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box">
            <div class="page-title-right">
                <form class="d-flex">
                    <button type="button" class="btn btn-primary" onclick="$('#addPersonal').modal('show')">+ Əlavə et</button>
                </form>
            </div>
            <h4 class="page-title">Personal</h4>
        </div>
    </div>
</div>

<!-- ================================================== -->
<!-- MAIN CONTENT SECTION -->
<!-- ================================================== -->
<div class="row">
    <!-- PERSONAL LIST COLUMN -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header bg-transparent">
                Personal siyahısı
                <div class="form-group float-right">
                    <select class="form-control" required id="depIsActiveFilter" onchange="$('.depTypesInBuildingItem.active').click();">
                        <option value="1">Aktiv</option>
                        <option value="0">Deaktiv</option>
                    </select>
                </div>
            </div>
            <div class="card-header">
                <div class="row">
                    <div class="col-6">Adı</div>
                    <div class="col-6 text-right">İxtisas</div>
                </div>
            </div>
            <div class="list-group list-group-flush" style="max-height: 50vh; overflow-y: auto" id="depTypesInBuilding">
                @foreach (var item in Model.personalList)
                {
                    <div class="list-group-item list-group-item-action personal-list" onclick='personalClicked(this, @Html.Raw(Json.Serialize(item)));'>
                        <div class="row">
                            <div class="col-6">@item.name @item.surname</div>
                            <div class="col-6 text-right">@item.speciality.name</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- PERSONAL DETAILS COLUMN -->
    <div class="col-md-9">
        <div class="card selectedDepCard">
            <div class="card-header bg-transparent">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="generalSettingsButton" onclick="settingsBoxClicked(1)">Ümumi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="positionSettingsButton" onclick="settingsBoxClicked(2)">Vəzifə yeri</a>
                    </li>
                </ul>
            </div>
            <div class="card-body bg-transparent">
                <!-- GENERAL SETTINGS -->
                <div id="generalSettings">
                    <ul class="nav nav-pills mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">Əsas məlumatlar</a>
                        </li>
                    </ul>
                    <div class="row mb-3">
                        <div class="col-9">
                            <!-- Personal Basic Information -->
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Registr kodu</label>
                                        <input type="text" class="form-control" id="reqCode" value="@currentUser.ID" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Ad</label>
                                        <input type="text" class="form-control" id="name" value="@currentUser.name" placeholder="-">
                                    </div>
                                    <div class="col-md-4">
                                        <label>Soyad</label>
                                        <input type="text" class="form-control" id="surname" value="@currentUser.surname" placeholder="00000">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Ata adı</label>
                                        <input type="text" class="form-control" id="father" value="@currentUser.father" placeholder="-">
                                    </div>
                                    <div class="col-md-4">
                                        <label>ŞV Seriyası</label>
                                        <input type="text" class="form-control" id="passportSerialNum" value="@currentUser.passportSerialNum" placeholder="-">
                                    </div>
                                    <div class="col-md-4">
                                        <label>ŞV FİN</label>
                                        <input type="text" class="form-control" id="passportFin" value="@currentUser.fin" placeholder="-">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Doğum tarixi</label>
                                        <input type="date" class="form-control" id="bDate" value="@currentUser.passportSerialNum">
                                    </div>
                                    <div class="col-md-4">
                                        <label>İxtisas</label>
                                        <select class="form-control" id="speciality">
                                            @foreach (var item in Model.specialityList)
                                            {
                                                if (currentUser.speciality.id == item.id)
                                                {
                                                    <option value="@item.id" selected data-foo="@item.id">@item.name</option>
                                                }
                                                else
                                                {
                                                    <option value="@item.id" data-foo="@item.id">@item.name</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Mobil nömrə</label>
                                        <input type="text" class="form-control" id="mobile" value="@currentUser.mobile" placeholder="00000">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>E-poçt ünvanı</label>
                                        <input type="text" class="form-control" value="@currentUser.email" id="email" placeholder="e-poçt">
                                    </div>
                                    <div class="col-md-6">
                                        <label>İstifadəçi adı</label>
                                        <input type="text" class="form-control" id="username" value="@currentUser.username" placeholder="Yoxdur">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <!-- Role Checkboxes -->
                                    <div class="col-md-3 mb-2">
                                        <input class="me-1" id="isActiveCheckBox" type="checkbox" @(currentUser.roles?.Count() > 0 ? "checked" : "")>
                                        <label>Aktiv</label>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <input class="me-1" id="isDrCheckBox" type="checkbox" @(currentUser.roles.Select(r => r.id).Contains(4) ? "checked" : "")>
                                        <label>Həkim</label>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <input class="me-1" id="isUserCheckBox" type="checkbox" @(currentUser.roles.Select(r => r.id).Contains(6) ? "checked" : "")>
                                        <label>İstifadəçi</label>
                                    </div>
                                    @if (currentUser.roles.Select(r => r.id).Contains(2))
                                    {
                                        <div class="col-md-3" id="adminCheckbox">
                                            <input class="me-1" id="isAdminCheckBox" type="checkbox" checked>
                                            <label>Admin</label>
                                        </div>
                                    }
                                    <div class="col-md-3 mb-2">
                                        <input class="me-1" id="isManagerCheckBox" type="checkbox" @(currentUser.roles.Select(r => r.id).Contains(3) ? "checked" : "")>
                                        <label>İnzibatçı</label>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <input class="me-1" id="isCashierCheckBox" type="checkbox" @(currentUser.roles.Select(r => r.id).Contains(5) ? "checked" : "")>
                                        <label>Kassir</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Profile Image & Actions -->
                        <div class="col-3">

                            @{
                                var imageSrc = "/res/user.svg";
                                if (!string.IsNullOrEmpty(currentUser.imagePath as string))
                                {
                                    var filePath = currentUser.imagePath.Replace("\\", "/");
                                    imageSrc = filePath;

                                }
                            }
                            <div class="form-group text-center">
                                <img id="profilePic" src="@imageSrc" width="86" style="object-fit:cover;" alt="" class="rounded-circle mx-auto d-block img-fluid mb-2">
                            </div>
                            @*<div class="">
                                <img src="/res/user.svg" class="rounded mx-auto d-block img-fluid" style="width:120px; height:160px" alt="User Image">
                            </div>*@
                            <div class="form-group">
                                <button type="button" class="form-control rounded text-white btn shadow-lg bg-secondary" onclick="$('#passChangeModal').modal('show')">Yeni şifrə</button>
                            </div>
                            <div class="form-group">
                                <button type="button" class="form-control btn text-info">Rəsmi imza</button>
                            </div>
                        </div>
                    </div>
                    <!-- Save Button -->
                    <div class="form-group border-top mt-3">
                        <div class="row">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn text-info" onclick="updateUser()">Yadda saxla</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POSITION SETTINGS -->
                <div id="positionSettings" style="display:none">
                    <ul class="nav nav-pills m-3 mb-4">
                        <li class="nav-item">
                            <a class="nav-link active" id="depTogle" onclick="KassaOrDepClicked(1)">Şöbələr</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="kassaTogle" onclick="KassaOrDepClicked(2)">Kassa</a>
                        </li>
                    </ul>
                    @if (currentUser.roles.Select(r => r.id).Contains(2))
                    {
                        <div class="ml-3 mb-3">
                            <label>Müəssisə</label>
                            <div class="row">
                                <div class="col-4">
                                    <div class="dropdown">
                                        <button class="btn btn-outline-dark dropdown-toggle w-100" type="button" id="userOrganizations" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
                                        <div class="dropdown-menu">
                                            <h6 class="dropdown-header">Əlavə olunmuş müəssisələr</h6>
                                            <div id="userOrganizationsMenu"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-8">
                                    <button type="button" class="btn btn-light" onclick="$('#addOrganization').modal('show');">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                          <path fill-rule="evenodd" clip-rule="evenodd" d="M15 13H13V15C13 15.55 12.55 16 12 16C11.45 16 11 15.55 11 15V13H9C8.45 13 8 12.55 8 12C8 11.45 8.45 11 9 11H11V9C11 8.45 11.45 8 12 8C12.55 8 13 8.45 13 9V11H15C15.55 11 16 11.45 16 12C16 12.55 15.55 13 15 13ZM12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2Z" fill="#2AAEAD"></path>
                                      </svg> müəssisə əlavə et
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                    <!-- Departments and Kassas Lists -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-light" id="userDepList">
                                <div class="card-header">
                                    <div class="row justify-content-end mb-1">
                                        <div class="col-auto">
                                            <button type="button" class="btn shadow-lg float-right" onclick="$('#addDepartment').modal('show');">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M15 13H13V15C13 15.55 12.55 16 12 16C11.45 16 11 15.55 11 15V13H9C8.45 13 8 12.55 8 12C8 11.45 8.45 11 9 11H11V9C11 8.45 11.45 8 12 8C12.55 8 13 8.45 13 9V11H15C15.55 11 16 11.45 16 12C16 12.55 15.55 13 15 13ZM12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2Z" fill="#2AAEAD"></path>
                                                </svg>
                                                Şöbə əlavə et
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-3">Şöbənin adı</div>
                                        <div class="col-2">Tipi</div>
                                        <div class="col-2">Gör</div>
                                        <div class="col-3">Tam kontrol</div>
                                        <div class="col-2">Sil</div>
                                    </div>
                                </div>
                                <div class="list-group list-group-flush" style="max-height: 30vh; overflow-y: auto" id="depsInOrganizationByUser">
                                    <!-- Filled dynamically -->
                                </div>
                            </div>
                            <div class="card border-light" id="userKassaList" style="display:none">
                                <div class="card-header">
                                    <div class="row justify-content-end mb-1">
                                        <div class="col-auto">
                                            <button type="button" class="btn rounded shadow float-right" onclick="$('#addKassa').modal('show');">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M15 13H13V15C13 15.55 12.55 16 12 16C11.45 16 11 15.55 11 15V13H9C8.45 13 8 12.55 8 12C8 11.45 8.45 11 9 11H11V9C11 8.45 11.45 8 12 8C12.55 8 13 8.45 13 9V11H15C15.55 11 16 11.45 16 12C16 12.55 15.55 13 15 13ZM12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2Z" fill="#2AAEAD"></path>
                                                </svg>
                                                Kassa əlavə et
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-5">Kassa adı</div>
                                        <div class="col-2">Gör</div>
                                        <div class="col-3">Tam kontrol</div>
                                        <div class="col-2">Sil</div>
                                    </div>
                                </div>
                                <div class="list-group list-group-flush" style="max-height: 30vh; overflow-y: auto" id="kassaInOrganizationByUser">
                                    <!-- Filled dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================================================== -->
<!-- MODAL DIALOGS SECTION -->
<!-- ================================================== -->
<!-- Pass Change Modal -->
<div class="modal fade" id="passChangeModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <img src="/res/pencil.svg" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <h6>İstifadəçi şifrəsinin sıfırlanması</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Yeni şifrə</label>
                                        <input class="form-control" placeholder="Şifrə..." id="newPwd" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="updateUserPwd()">Yenilə</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Kassa Modal -->
<div class="modal fade" id="addKassa" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <img src="/res/pencil.svg" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <h6>İstifadəçiyə kassa əlavə edilməsi</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Kassalar</label>
                                        <select class="form-control dropdown" required id="kassaInOrganization"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12" style="display:inline">
                                        <input class="me-1" id="kassaReadOnlyCheckBox" type="checkbox" value="">
                                        <label>Gör</label>
                                    </div>
                                    <div class="col-md-12" style="display:inline">
                                        <input class="me-1" id="kassaFullKontrolCheckBox" type="checkbox" value="">
                                        <label>Tam kontrol</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="addKassaToUser()">Əlavə et</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartment" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <img src="/res/pencil.svg" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <h6>İstifadəçiyə şöbənin əlavə edilməsi</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Şöbələr</label>
                                        <select class="form-control dropdown" required id="depsInOrganization"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12" style="display:inline">
                                        <input class="me-1" id="depReadOnlyCheckBox" type="checkbox" value="">
                                        <label>Gör</label>
                                    </div>
                                    <div class="col-md-12" style="display:inline">
                                        <input class="me-1" id="depFullControlCheckBox" type="checkbox" value="">
                                        <label>Tam kontrol</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="addDepartmentToUser()">Əlavə et</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Organization Modal -->
<div class="modal fade" id="addOrganization" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <img src="/res/pencil.svg" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <h6>İstifadəçiyə müəssisə əlavə edilməsi</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label>Müəssisələr</label>
                                        <select class="form-control dropdown" required id="allOrganizations">
                                            @foreach (var item in Model.organizationList)
                                            {
                                                <option value="@item.id">@item.organizationName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="addOrganizationToUser()">Əlavə et</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Personal Modal -->
<div class="modal fade" id="addPersonal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
            </div>
            <div class="modal-body">
                <form id="addPersonalForm" class="needs-validation container" novalidate>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <img src="/res/user.svg" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <h3>Personal əlavə edilməsi</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Adı</label>
                                        <input type="text" class="form-control" required id="newUserName" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Soyadı</label>
                                        <input type="text" class="form-control" required id="newUserSurname" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Ata adı</label>
                                        <input type="text" class="form-control" required id="newUserFather" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Doğum tarixi</label>
                                        <input type="date" class="form-control" required id="newUserBDate" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>ŞV seriyası</label>
                                        <input type="text" class="form-control" required id="newUserPassportSerialNo" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Fin No</label>
                                        <input type="text" class="form-control" required id="newUserFin" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Mobil nömrə</label>
                                        <input type="text" class="form-control" required id="newUserMobile" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Elektron poçt ünvanı</label>
                                        <input type="text" class="form-control" required id="newUserEmail" placeholder="Daxil edin">
                                        <div class="valid-feedback">Əla!</div>
                                        <div class="invalid-feedback">Boşluğu doldurun.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Vəzifə</label>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-dark dropdown-toggle w-100" type="button" id="rolesDropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                                Seçin
                                            </button>
                                            <ul class="dropdown-menu" id="rolesSelectDropdownMenu" aria-labelledby="rolesDropdownMenuButton">
                                                <li>
                                                    <label class="dropdown-item">
                                                        <input type="checkbox" value="3" class="form-check-input me-2"> İnzibatçı
                                                    </label>
                                                </li>
                                                <li>
                                                    <label class="dropdown-item">
                                                        <input type="checkbox" value="4" class="form-check-input me-2"> Həkim
                                                    </label>
                                                </li>
                                                <li>
                                                    <label class="dropdown-item">
                                                        <input type="checkbox" value="5" class="form-check-input me-2"> Kassir
                                                    </label>
                                                </li>
                                                <li>
                                                    <label class="dropdown-item">
                                                        <input type="checkbox" value="6" checked class="form-check-input me-2"> İstifadəçi
                                                    </label>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6" id="newUserSpecialityContent" style="display:none;">
                                        <label>İxtisas</label>
                                        <div class="dropdown">
                                            <button type="button" class="btn btn-outline-dark dropdown-toggle w-100" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="justify-content-end newUserSpeciality">Seçin...</span>
                                            </button>
                                            <div class="dropdown-menu">
                                                @foreach (var item in Model.specialityList)
                                                {
                                                    <a class="dropdown-item" id="@item.id" onclick="$('.newUserSpeciality').text('@item.name'); $('.newUserSpeciality').attr('id','@item.id');">@item.name</a>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="container mt-5">
                                <div class="form-group mb-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-12">
                                            <h3>İstifadəçi məlumatları</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>İstifadəçi adı</label>
                                            <input type="text" class="form-control" id="newUserUsername" placeholder="Daxil edin">
                                            <div class="valid-feedback">Əla!</div>
                                            <div class="invalid-feedback">Boşluğu doldurun.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label>Şifrə</label>
                                            <input type="text" class="form-control" id="newUserPwd" placeholder="Daxil edin" required>
                                            <div class="valid-feedback">Əla!</div>
                                            <div class="invalid-feedback">Boşluğu doldurun.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <button type="button" class="btn btn-primary" onclick="addPersonal()">Əlavə et</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================================================== -->
<!-- SYSTEM & WARNING MODALS (DUMMY) -->
<!-- ================================================== -->
<div class="modal fade" id="systemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="systemModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="systemModalText"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="systemModalBtn" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="warningModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Warning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="warningText"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ================================================== -->
<!-- CUSTOM STYLES -->
<!-- ================================================== -->
<style>
    .nav-pills .nav-link.active {
        border-radius: 2rem;
        background-color: #2AAEAD;
    }

    .nav-pills .nav-link {
        margin: 0.25rem !important;
        border-radius: 2rem;
        border: 1px solid #dee2e6 !important;
        color: #2AAEAD;
    }
</style>

<!-- ================================================== -->
<!-- SCRIPTS SECTION -->
<!-- ================================================== -->
@section Scripts {
    <script>
        var selectedOrganization;
        var selectedPersonalID = @Model.personalList[0].ID;
        getOrganizationsByUser(selectedPersonalID);
        var newPersonalIsUser = 0;

        function checkIsUserBox(state) {
            if ($(state).is(':checked')) {
                $("#newUserUsername").prop('required', true);
                $("#newUserPwd").prop('required', true);
                newPersonalIsUser = 1;
            } else {
                newPersonalIsUser = 0;
                $("#newUserUsername").prop('required', false);
                $("#newUserPwd").prop('required', false);
            }
        }

        function updateUser() {
            var userSpecialityOption = $("#speciality").find('option:selected');
            var userSpecialityID = userSpecialityOption.data('foo');
            var userID = $("#reqCode").val();
            var bDate = $("#bDate").val();
            var mobile = $("#mobile").val();
            var email = $("#email").val();
            var username = $("#username").val();
            var name = $("#name").val();
            var surname = $("#surname").val();
            var father = $("#father").val();
            var passportSerialNum = $("#passportSerialNum").val();
            var fin = $("#passportFin").val();
            var isActiveCheckBox = $("#isActiveCheckBox").prop('checked') ? 1 : 0;
            var selectedValues = [];
            if ($("#isDrCheckBox").prop('checked')) { selectedValues.push(4); }
            if ($("#isUserCheckBox").prop('checked')) { selectedValues.push(6); }
            if ($("#isAdminCheckBox").prop('checked')) { selectedValues.push(2); }
            if ($("#isManagerCheckBox").prop('checked')) { selectedValues.push(3); }
            if ($("#isCashierCheckBox").prop('checked')) { selectedValues.push(5); }

            $.post("@Url.Action("UpdateUser", "Personal", new { area = "Admin" })",
                { userID: userID, mobile: mobile, email: email, username: username, bDate: bDate, passportSerialNum: passportSerialNum, fin: fin, specialityID: userSpecialityID, name: name, surname: surname, father: father, isActive: isActiveCheckBox, roleIds: selectedValues },
                function (data) {
                    $('#systemModal').modal('hide');
                    $('#warningModal').modal('show');
                    $('#warningText').text(data > 0 ? 'Məlumatlar yeniləndi' : 'Məlumatlar yenilənmədi');
                }
            );
        }

        function updateUserPwd() {
            var userID = $("#reqCode").val();
            var pwd = $("#newPwd").val();
            $.post("@Url.Action("UpdateUserPwd", "Personal", new { area = "Admin" })",
                { userID: userID, pwd: pwd },
                function (data) {
                    $('#systemModal').modal('hide');
                    $('#warningModal').modal('show');
                    $('#warningText').text(data > 0 ? 'Şifrə sıfırlandı' : 'Məlumatlar yenilənmədi');
                }
            );
        }

        function getOrganizationsByUser(personalID) {
            $.get("@Url.Action("OrganizationsByUser", "Personal", new { area = "Admin" })",
                { personalID: selectedPersonalID },
                function (data) {
                    if (data.length > 0) {
                        $("#userOrganizations").text(data[0].organizationName).val(data[0].organizationID);
                        selectedOrganization = data[0].organizationID;
                        $("#userOrganizationsMenu").empty();
                        $.each(data, function () {
                            $("#userOrganizationsMenu").append($(`
                                <div class="row m-1">
                                    <div class="col-9">
                                        <a class="dropdown-item" id=${this.id} onclick="$('#userOrganizations').text('${this.organizationName}').val('${this.organizationID}'); getDepartmentsByOrganization(${this.organizationID}); getKassaByOrganization(); getUserKassaByOrganization(); getUserDepsByOrganization();">
                                            ${this.organizationName}
                                        </a>
                                    </div>
                                    <div class="col-3">
                                        <button class='btn text-danger' onclick='removeOrganizationFromUser(${this.organizationID});'>Sil</button>
                                    </div>
                                </div>
                            `));
                        });
                        getDepartmentsByOrganization($('#userOrganizations').val());
                        getUserDepsByOrganization();
                        getUserKassaByOrganization();
                        getKassaByOrganization();
                    } else {
                        selectedOrganization = 0;
                        $("#userOrganizations").text("Əlavə edin");
                        $("#userOrganizationsMenu").empty();
                        $("#depsInOrganizationByUser").empty().append($(`<div class='text-center m-3'><img style='height:100px' src="/res/empty.png"/><br><h2 class='mt-3'>Boşdur</h2></div>`));
                    }
                }
            );
        }

        function getDepartmentsByOrganization(organizationID) {
            $("#depsInOrganization").empty();
            $.get("@Url.Action("DepartmentsByOrganization", "Personal", new { area = "Admin" })",
                { organizationID: organizationID },
                function (data) {
                    if (data.length > 0) {
                        $.each(data, function () {
                            $("#depsInOrganization").append($(`
                                <option id='${this.id}'>${this.name} - ${this.type}</option>
                            `));
                        });
                    }
                }
            );
        }

        function getKassaByOrganization() {
            $("#kassaInOrganization").empty();
            $.get("@Url.Action("GetAllKassaByOrganization", "Personal", new { area = "Admin" })",
                { organizationID: $('#userOrganizations').val() },
                function (data) {
                    if (data.length > 0) {
                        $.each(data, function () {
                            $("#kassaInOrganization").append($(`
                                <option id='${this.id}'>${this.name}</option>
                            `));
                        });
                    }
                }
            );
        }

        function personalClicked(component, obj) {

            selectedPersonalID = obj.id;
            $('.personal-list').removeClass('active');
            $(component).addClass('active');
            $("#reqCode").val(obj.id);
            var today = new Date(obj.bDate).toISOString().split('T')[0];
            $("#bDate").val(today);
            $("#speciality").val(obj.speciality.id);
            $("#mobile").val(obj.mobile);
            $("#email").val(obj.email);
            $("#father").val(obj.father);
            $("#name").val(obj.name);
            $("#surname").val(obj.surname);
            $("#passportSerialNum").val(obj.passportSerialNum);
            $("#passportFin").val(obj.fin);
            $("#username").val(obj.username);
            var imagePath = obj.imagePath && obj.imagePath.trim() !== "" ? obj.imagePath : "/res/user.svg";
            $("#profilePic").attr("src", imagePath);
            var roles = obj.roles;
            var roleIds = roles.map(r => r.id);
            $("#isActiveCheckBox").prop('checked', roleIds.length > 0);
            updateCheckBoxStatus(2, "#isAdminCheckBox", roleIds);
            updateCheckBoxStatus(3, "#isManagerCheckBox", roleIds);
            updateCheckBoxStatus(4, "#isDrCheckBox", roleIds);
            updateCheckBoxStatus(6, "#isUserCheckBox", roleIds);
            getOrganizationsByUser(selectedPersonalID);
        }

        function updateCheckBoxStatus(statusId, checkboxId, statusList) {
            $(checkboxId).prop('checked', statusList.includes(statusId));
        }

        function getUserDepsByOrganization() {
            $("#depsInOrganizationByUser").empty();
            var userDeps;
            $.get("@Url.Action("GetDepartmentsByUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val() },
                function (data) {
                    if (data.length > 0) {
                        userDeps = data;
                        $.get("/Admin/Personal/DepartmentsByOrganization",
                            { organizationID: $("#userOrganizations").val() },
                            function (data) {
                                if (data.length > 0) {
                                    var depsByOrganization = data;
                                    for (let a = 0; a < userDeps.length; a++) {
                                        for (let i = 0; i < depsByOrganization.length; i++) {
                                            if (depsByOrganization[i].id == userDeps[a].depID) {
                                                var readOnlyCheckBox = userDeps[a].readOnly > 0 ?
                                                    '<input class="me-1" type="checkbox" checked onclick="return false">' :
                                                    '<input class="me-1" type="checkbox" onclick="return false">';
                                                var fullAccessCheckBox = userDeps[a].fullAccess > 0 ?
                                                    '<input class="me-1" type="checkbox" checked onclick="return false">' :
                                                    '<input class="me-1" type="checkbox" onclick="return false">';
                                                $("#depsInOrganizationByUser").append($(`
                                                    <div class="list-group-item list-group-item-action dep-list" id=${depsByOrganization[i].id}>
                                                        <div class="row">
                                                            <div class="col-3">${depsByOrganization[i].name}</div>
                                                            <div class="col-2">${depsByOrganization[i].type}</div>
                                                            <div class="col-2">${readOnlyCheckBox}</div>
                                                            <div class="col-3">${fullAccessCheckBox}</div>
                                                            <div class="col-2">
                                                                <a class='text-danger' onclick='removeDepFromUser(${depsByOrganization[i].id});'>Sil</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `));
                                            }
                                        }
                                    }
                                } else {
                                    $("#depsInOrganizationByUser").empty().append($(`<div class='text-center m-3'><img style='height:100px' src="/res/empty.png"/><br><h2 class='mt-3'>Boşdur</h2></div>`));
                                }
                            }
                        );
                    } else {
                        $("#depsInOrganizationByUser").empty().append($(`<div class='text-center m-3'><img style='height:100px' src="/res/empty.png"/><br><h2 class='mt-3'>Boşdur</h2></div>`));
                    }
                }
            );
        }

        function getUserKassaByOrganization() {
            $("#kassaInOrganizationByUser").empty();
            $.get("@Url.Action("GetUserKassaByOrganization", "Personal", new { area = "Admin" })",
                { organizationID: $("#userOrganizations").val(), userID: $("#reqCode").val() },
                function (data) {
                    if (data.length > 0) {
                        $.each(data, function () {
                            var readOnlyCheckBox = this.readOnly > 0 ?
                                '<input class="me-1" type="checkbox" checked onclick="return false">' :
                                '<input class="me-1" type="checkbox" onclick="return false">';
                            var fullAccessCheckBox = this.fullAccess > 0 ?
                                '<input class="me-1" type="checkbox" checked onclick="return false">' :
                                '<input class="me-1" type="checkbox" onclick="return false">';
                            $("#kassaInOrganizationByUser").append($(`
                                <div class="list-group-item list-group-item-action kassa-list" id='${this.id}'>
                                    <div class="row">
                                        <div class="col-5">${this.name}</div>
                                        <div class="col-2">${readOnlyCheckBox}</div>
                                        <div class="col-3">${fullAccessCheckBox}</div>
                                        <div class="col-2">
                                            <a class='text-danger' onclick='removeKassaFromUser(${this.kassaID});'>Sil</a>
                                        </div>
                                    </div>
                                </div>
                            `));
                        });
                    } else {
                        $("#kassaInOrganizationByUser").empty().append($(`<div class='text-center m-3'><img style='height:100px' src="/res/empty.png"/><br><h2 class='mt-3'>Boşdur</h2></div>`));
                    }
                }
            );
        }

        function settingsBoxClicked(box) {
            switch (box) {
                case 1:
                    $('#positionSettings').hide();
                    $('#generalSettings').show();
                    $("#generalSettingsButton").addClass("active");
                    $("#positionSettingsButton").removeClass("active");
                    break;
                case 2:
                    $('#generalSettings').hide();
                    $('#positionSettings').show();
                    $("#positionSettingsButton").addClass("active");
                    $("#generalSettingsButton").removeClass("active");
                    break;
            }
        }

        function KassaOrDepClicked(state) {
            switch (state) {
                case 1:
                    $('#userKassaList').hide();
                    $('#userDepList').show();
                    $("#depTogle").addClass("active");
                    $("#kassaTogle").removeClass("active");
                    break;
                case 2:
                    $('#userKassaList').show();
                    $('#userDepList').hide();
                    $("#kassaTogle").addClass("active");
                    $("#depTogle").removeClass("active");
                    break;
            }
        }

        $("#rolesSelectDropdownMenu").on('click', function (event) {
            event.stopPropagation();
        });

        $('#rolesSelectDropdownMenu input[type="checkbox"]').on('change', function () {
            var selectedValues = [];
            $('#rolesSelectDropdownMenu input[type="checkbox"]:checked').each(function () {
                selectedValues.push($(this).val());
            });
            $("#newUserSpecialityContent").toggle(selectedValues.includes('4'));
        });

        $('#addPersonal').on('hidden.bs.modal', function () {
            var $form = $('#addPersonalForm');
            $form.removeClass('was-validated');
            $form[0].reset();
        });

        function addPersonal() {
            var forms = document.getElementsByClassName('needs-validation');
            Array.prototype.filter.call(forms, function (form) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
            if (forms[0].checkValidity()) {
                var newUserIsDr = $("#isDr").is(':checked') ? 1 : 0;
                var admin = $("#admin").is(':checked') ? 1 : 0;
                var name = $('#newUserName').val();
                var surname = $('#newUserSurname').val();
                var father = $('#newUserFather').val();
                var phone = $('#newUserMobile').val();
                var email = $('#newUserEmail').val();
                var bDate = $('#newUserBDate').val();
                var fin = $("#newUserFin").val();
                var passportSerialNo = $("#newUserPassportSerialNo").val();
                var username = $("#newUserUsername").val();
                var password = $("#newUserPwd").val();
                var specialityID = $('.newUserSpeciality').attr('id');
                var roleIds = [];
                $('#rolesSelectDropdownMenu input[type="checkbox"]:checked').each(function () {
                    roleIds.push($(this).val());
                });
                $('#systemModal').modal('show');
                $('#systemModalTitle').text("Yüklənir...");
                $('#systemModalText').html(`<center><div class="spinner-border text-dark mx-auto" role="status"></div></center>`);
                $('#systemModalBtn').attr("hidden", "");
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Add", "Personal", new { area = "Admin" })",
                    data: {
                        "name": name,
                        "surname": surname,
                        "father": father,
                        "specialityID": specialityID,
                        "passportSerialNum": passportSerialNo,
                        "fin": fin,
                        "phone": phone,
                        "email": email,
                        "username": username,
                        "pwd": password,
                        "bDate": bDate,
                        "roleIds": roleIds
                    },
                    success: function (data, status, xhr) {
                        if (data > 0) {
                            $('#systemModal').modal('hide');
                            $('#warningModal').modal('show');
                            $('#warningText').text('Personal əlavə olundu!');
                        } else {
                            $('#systemModal').modal('hide');
                            $('#warningModal').modal('show');
                            $('#warningText').text('Personal artıq mövcuddur!');
                        }
                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                        if (jqXhr.status == 401) {
                            $('#systemModalTitle').text("Sessiyanız başa çatıb");
                            $('#systemModalText').html(`<p>Zəhmət olmasa yenidən giriş edin</p>`);
                            $('#systemModalBtn').removeAttr("hidden");
                        } else {
                            $('#systemModal').modal('hide');
                            $('#warningModal').modal('show');
                            $('#warningText').text('Xəta, biraz sonra yenidən cəhd edin');
                        }
                    }
                });
            }
        }

        function addOrganizationToUser() {
            $.post("@Url.Action("AddOrganizationToUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val(), organizationID: $("#allOrganizations").val() },
                function (data) {
                    if (data > 0) {
                        getOrganizationsByUser($('#reqCode').val());
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Müəssisə əlavə olundu!');
                    } else {
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Müəssisə artıq əlavə olunub!');
                    }
                }
            );
        }

        function removeOrganizationFromUser(organizationID) {
            $.post("@Url.Action("RemoveOrganizationFromUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val(), organizationID: organizationID },
                function (data) {
                    if (data > 0) {
                        getOrganizationsByUser($('#reqCode').val());
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Müəssisə silindi!');
                    } else {
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Müəssisə silinmədi!');
                    }
                }
            );
        }

        function addDepartmentToUser() {
            var id = $("#depsInOrganization").find('option:selected').attr('id');
            $.post("@Url.Action("AddDepToUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val(), depID: id, read_only: $("#depReadOnlyCheckBox").is(":checked"), full_access: $("#depFullControlCheckBox").is(":checked") },
                function (data) {
                    if (data > 0) {
                        getOrganizationsByUser($('#reqCode').val());
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Şöbə əlavə olundu!');
                    } else {
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Şöbə artıq əlavə olunub!');
                    }
                }
            );
        }

        function removeDepFromUser(userDepID) {
            $.post("@Url.Action("RemoveDepFromUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val(), depID: userDepID },
                function (data) {
                    if (data > 0) {
                        getUserDepsByOrganization();
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Şöbə silindi!');
                    } else {
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Şöbə silinmədi!');
                    }
                }
            );
        }

        function addKassaToUser() {
            var id = $("#kassaInOrganization").find('option:selected').attr('id');
            $.post("@Url.Action("AddKassaToUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val(), kassaId: id, read_only: $("#kassaReadOnlyCheckBox").is(":checked"), full_access: $("#kassaFullControlCheckBox").is(":checked") },
                function (data) {
                    if (data > 0) {
                        getUserKassaByOrganization();
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Kassa əlavə olundu!');
                    } else {
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Kassa artıq əlavə olunub!');
                    }
                }
            );
        }

        function removeKassaFromUser(kassaID) {
            $.post("@Url.Action("RemoveKassaFromUser", "Personal", new { area = "Admin" })",
                { userID: $("#reqCode").val(), kassaId: kassaID },
                function (data) {
                    if (data > 0) {
                        getUserKassaByOrganization();
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Kassa silindi!');
                    } else {
                        $('#systemModal').modal('hide');
                        $('#warningModal').modal('show');
                        $('#warningText').text('Kassa silinmədi!');
                    }
                }
            );
        }
    </script>
}
